# Data Model: AI Charts Homepage

**Feature**: 001-ai-chart-homepage  
**Date**: 2026-01-08  
**Input**: [spec.md](./spec.md), [research.md](./research.md)

## Entity Definitions

### 1. ChartPrompt

**Purpose**: Represents the user's natural language input containing data and visualization intent

**TypeScript Interface**:
```typescript
interface ChartPrompt {
  /** Raw user input text */
  text: string;
  
  /** Detected language (zh-CN, en-US, etc.) */
  language?: string;
  
  /** When the prompt was submitted */
  timestamp: Date;
  
  /** Optional user session identifier (for analytics, not persistence) */
  sessionId?: string;
}
```

**Attributes**:
- `text` (required): The complete user input, including data, labels, and optional chart type specification
- `language` (optional): Auto-detected or manually specified language for LLM context
- `timestamp` (required): Used for logging and temporary session tracking
- `sessionId` (optional): Anonymous identifier for analytics (no user authentication)

**Validation Rules**:
- `text` must not be empty
- `text` length should be < 10,000 characters (practical limit)
- No special validation for language (LLM handles detection)

**Usage**:
- Created when user submits input
- Passed to API route for processing
- Not persisted (stateless application)

---

### 2. ExtractedData

**Purpose**: Structured representation of data parsed from the user's prompt by the LLM

**TypeScript Interface**:
```typescript
interface DataSeries {
  /** Name/label for this series (e.g., "北京", "上海", "Sales") */
  name: string;
  
  /** Array of numerical values */
  values: number[];
  
  /** Optional: Unit of measurement (e.g., "万元", "USD", "%") */
  unit?: string;
}

interface ExtractedData {
  /** Array of data series (1 for single series, multiple for comparison) */
  series: DataSeries[];
  
  /** Labels for x-axis or categories */
  labels: string[];
  
  /** Data type classification */
  dataType: 'numerical' | 'categorical' | 'temporal';
  
  /** Total count of data points across all series */
  totalPoints: number;
  
  /** Chart title extracted from prompt */
  title?: string;
  
  /** User-specified chart type, if explicitly mentioned */
  explicitChartType?: ChartType;
}
```

**Attributes**:
- `series`: One or more data series to be visualized
  - Each series has a name and array of values
  - Values must be numbers (LLM handles conversion)
- `labels`: Correspond to x-axis categories or time periods
  - Length should match `values.length` for each series
- `dataType`: Helps determine optimal chart type
  - `numerical`: Pure numerical comparison
  - `categorical`: Named categories (e.g., products, regions)
  - `temporal`: Time-series data (dates, months, years)
- `totalPoints`: Sum of all data points across all series
- `title`: Chart title derived from prompt context
- `explicitChartType`: Chart type if user specified (e.g., "bar chart", "折线图")

**Validation Rules**:
- At least one series required
- All series must have same length of values
- `labels.length` must equal `series[*].values.length`
- `totalPoints` must not exceed 1000
- `values` must contain only valid numbers (no NaN, Infinity)

**Usage**:
- Generated by LLM during prompt processing
- Intermediate representation (not directly exposed to frontend)
- Used to construct ChartConfiguration

---

### 3. ChartType

**Purpose**: Enumeration of supported chart visualization types

**TypeScript Type**:
```typescript
type ChartType = 
  | 'line'      // Line chart - trends, time-series
  | 'bar'       // Bar chart - comparisons, rankings
  | 'pie'       // Pie chart - composition (single series only)
  | 'scatter'   // Scatter plot - correlations
  | 'area';     // Area chart - trends with magnitude

```

**Usage**:
- Determined by LLM based on data structure and user intent
- Can be explicitly specified in prompt (e.g., "用柱状图", "line chart")
- Each type has specific use cases:
  - `line`: Best for continuous data, trends over time
  - `bar`: Best for categorical comparisons, discrete values
  - `pie`: Best for composition, proportions (requires single series)
  - `scatter`: Best for correlations, distributions
  - `area`: Best for trends with emphasis on magnitude

**Extensibility**:
- Can be extended in future with additional types (stacked, grouped, etc.)
- Currently limited to basic types for MVP

---

### 4. ChartConfiguration

**Purpose**: Complete ECharts configuration ready for frontend rendering

**TypeScript Interface**:
```typescript
import type { EChartsOption } from 'echarts';

interface ChartConfiguration extends EChartsOption {
  /** Chart title */
  title: {
    text: string;
    left?: 'left' | 'center' | 'right';
  };
  
  /** Tooltip configuration */
  tooltip: {
    trigger: 'axis' | 'item';
    formatter?: string | Function;
  };
  
  /** Legend for multi-series charts */
  legend?: {
    data: string[];
    top?: string | number;
  };
  
  /** X-axis configuration */
  xAxis?: {
    type: 'category' | 'value' | 'time';
    data?: string[];
    name?: string;
  };
  
  /** Y-axis configuration */
  yAxis?: {
    type: 'value' | 'category';
    name?: string;
  };
  
  /** Data series array */
  series: Array<{
    name: string;
    type: ChartType;
    data: number[] | Array<{ name: string; value: number }>;
    itemStyle?: {
      color?: string;
    };
  }>;
  
  /** Grid/layout configuration */
  grid?: {
    left?: string | number;
    right?: string | number;
    top?: string | number;
    bottom?: string | number;
    containLabel?: boolean;
  };
  
  /** Toolbox for interactions */
  toolbox?: {
    feature?: {
      saveAsImage?: {};
      dataZoom?: {};
    };
  };
}
```

**Attributes**:
- Extends ECharts' native `EChartsOption` type
- All fields follow ECharts configuration schema
- Includes settings for:
  - Visual appearance (title, legend, colors)
  - Data representation (series, axes)
  - Interactivity (tooltip, zoom, pan)
  - Layout (grid, positioning)

**Validation Rules**:
- Must be valid ECharts configuration
- `series` array must not be empty
- Chart type must match data structure (e.g., pie charts need single series)
- Total data points across all series ≤ 1000

**Usage**:
- Generated by LLM in API route
- Validated before sending to frontend
- Passed directly to `echarts-for-react` component
- No transformation needed on frontend

---

### 5. APIRequest

**Purpose**: Request payload sent from frontend to API route

**TypeScript Interface**:
```typescript
interface APIRequest {
  /** User's natural language prompt */
  prompt: string;
  
  /** Optional: Client-provided session ID for analytics */
  sessionId?: string;
}
```

**Attributes**:
- `prompt`: The user's input text
- `sessionId`: Optional anonymous identifier (not used for authentication)

**Validation Rules**:
- `prompt` must be non-empty string
- `prompt` length < 10,000 characters
- No authentication required (public endpoint)

**Usage**:
- POSTed to `/api/generate-chart`
- Simple, minimal payload

---

### 6. APIResponse

**Purpose**: Response payload returned from API route

**TypeScript Interface**:
```typescript
interface APISuccessResponse {
  /** Complete ECharts configuration */
  config: ChartConfiguration;
  
  /** Processing metadata */
  metadata: {
    processingTime: number;  // milliseconds
    dataPoints: number;
    chartType: ChartType;
  };
}

interface APIErrorResponse {
  /** Error category */
  error: 'no_data' | 'validation_failed' | 'rate_limit' | 'server_error';
  
  /** User-friendly error message */
  message: string;
  
  /** Optional: Additional details for debugging */
  details?: string;
}

type APIResponse = APISuccessResponse | APIErrorResponse;
```

**Success Response**:
- `config`: Ready-to-use ECharts configuration
- `metadata`: Useful for logging and user feedback

**Error Response**:
- `error`: Machine-readable error category
- `message`: Human-readable description
- `details`: Optional technical information

**Error Categories**:
- `no_data`: Prompt contains no extractable numerical data
- `validation_failed`: LLM returned invalid configuration
- `rate_limit`: Too many requests to LLM service
- `server_error`: Generic server/LLM failure

**Usage**:
- Returned from `/api/generate-chart`
- Frontend checks for `error` field to determine success/failure
- Success: Renders chart with `config`
- Error: Displays alert with `message`

---

## Entity Relationships

```
┌─────────────────┐
│  ChartPrompt    │ (User Input)
└────────┬────────┘
         │
         │ sent to API
         ▼
┌─────────────────────────────┐
│  /api/generate-chart        │
│  1. Parse prompt            │
│  2. Call LLM                │
│  3. Extract data            │
│  4. Generate config         │
│  5. Validate                │
└────────┬────────────────────┘
         │
         ├──► ExtractedData (internal)
         │    └──► ChartType (selected)
         │
         ▼
┌─────────────────────────────┐
│  ChartConfiguration         │ (Output)
│  (ECharts config JSON)      │
└────────┬────────────────────┘
         │
         │ returned in APIResponse
         ▼
┌─────────────────────────────┐
│  Frontend                   │
│  - Renders with ECharts     │
│  - Enables download         │
│  - Shows errors             │
└─────────────────────────────┘
```

## Data Flow

1. **User Input** → `ChartPrompt` created from textarea
2. **API Call** → `APIRequest` POSTed to `/api/generate-chart`
3. **LLM Processing** → Prompt analyzed, data extracted into `ExtractedData`
4. **Config Generation** → `ChartConfiguration` created by LLM
5. **Validation** → Ensure config is valid and within limits
6. **Response** → `APIResponse` returned to frontend
7. **Rendering** → `ChartConfiguration` passed to ECharts component
8. **Download** → ECharts exports chart as image on demand

## TypeScript Module Structure

```typescript
// app/lib/types.ts
export type {
  ChartPrompt,
  ExtractedData,
  DataSeries,
  ChartType,
  ChartConfiguration,
  APIRequest,
  APIResponse,
  APISuccessResponse,
  APIErrorResponse
};
```

## Notes

- All entities are ephemeral (no database storage)
- Session IDs are optional and not used for authentication
- Data validation occurs at API route level
- Frontend receives ready-to-use ECharts configuration
- Type safety enforced throughout with TypeScript strict mode
